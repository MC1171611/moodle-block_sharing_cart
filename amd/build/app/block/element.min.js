define("block_sharing_cart/app/block/element",["exports","../../lib/sortablejs","core/modal_factory","core/modal_events","core/str","core/ajax","core/notification"],(function(_exports,_sortablejs,_modal_factory,_modal_events,_str,_ajax,_notification){function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}Object.defineProperty(_exports,"__esModule",{value:!0}),_exports.default=void 0,_sortablejs=_interopRequireDefault(_sortablejs),_modal_factory=_interopRequireDefault(_modal_factory),_modal_events=_interopRequireDefault(_modal_events),_ajax=_interopRequireDefault(_ajax),_notification=_interopRequireDefault(_notification);return _exports.default=class{#baseFactory;#element;#course;#queue;#items=[];#sortable=null;#clipboardItem=null;#canBackupUserdata=!1;#canAnonymizeUserdata=!1;#showSharingCartBasket=!1;#draggedCourseModuleId=null;#draggedSectionId=null;#bulkDeleteEnabled=!1;constructor(baseFactory,element,canBackupUserdata,canAnonymizeUserdata,showSharingCartBasket){this.#baseFactory=baseFactory,this.#element=element,this.#canBackupUserdata=canBackupUserdata,this.#canAnonymizeUserdata=canAnonymizeUserdata,this.#showSharingCartBasket=showSharingCartBasket}addEventListeners(){return this.setupCourse(),this.setupQueue(),this.setupItems(),this.setupDragAndDrop(),this.setupBulkDelete(),{course:this.#course,queue:this.#queue,block:this}}setupCourse(){const course=document.querySelector(".course-content");this.#course=this.#baseFactory.block().course().element(this,course)}setupQueue(){const queue=document.querySelector(".sharing_cart_queue");this.#queue=this.#baseFactory.block().queue().element(this,queue)}async setupItems(){const items=this.#element.querySelectorAll(".sharing_cart_item");for(const element of items)await this.setupItem(element);this.#sortable=new _sortablejs.default(this.#element.querySelector(".sharing_cart_items"),{dataIdAttr:"data-itemid",onUpdate:()=>{_ajax.default.call([{methodname:"block_sharing_cart_reorder_sharing_cart_items",args:{item_ids:this.#sortable.toArray().filter((id=>!isNaN(id)))},fail:data=>{_notification.default.exception(data)}}])}})}setupDragAndDrop(){const dropZone=this.#element;dropZone.addEventListener("dragover",(e=>{(this.#draggedSectionId||this.#draggedCourseModuleId)&&(e.preventDefault(),e.stopPropagation())})),dropZone.addEventListener("dragleave",(e=>{(this.#draggedSectionId||this.#draggedCourseModuleId)&&(e.preventDefault(),e.stopPropagation())})),dropZone.addEventListener("drop",(async e=>{(this.#draggedSectionId||this.#draggedCourseModuleId)&&(e.preventDefault(),e.stopPropagation(),this.#draggedSectionId?await this.addSectionBackupToSharingCart(this.#draggedSectionId):this.#draggedCourseModuleId&&await this.addCourseModuleBackupToSharingCart(this.#draggedCourseModuleId))}))}setupBulkDelete(){const enableBulkDeleteButton=this.#element.querySelector("#block_sharing_cart_bulk_delete"),disableBulkDeleteButton=this.#element.querySelector("#block_sharing_cart_cancel_bulk_delete"),bulkDeleteButton=this.#element.querySelector("#block_sharing_cart_bulk_delete_confirm"),selectAllContainer=this.#element.querySelector("#select_all_container");this.#element.querySelector("#select_all_box").addEventListener("click",(async()=>{const itemCheckboxes=this.getItemCheckboxes(),allSelected=Array.from(itemCheckboxes).every((checkbox=>checkbox.checked));itemCheckboxes.forEach((checkbox=>{checkbox.checked=!allSelected})),itemCheckboxes.forEach((checkbox=>checkbox.addEventListener("change",(async()=>{this.updateSelectAllState()})))),this.updateSelectAllState(),this.updateBulkDeleteButtonState()})),enableBulkDeleteButton.addEventListener("click",(()=>{0!==this.#items.length&&(this.#bulkDeleteEnabled=!0,enableBulkDeleteButton.classList.add("d-none"),disableBulkDeleteButton.classList.remove("d-none"),selectAllContainer.classList.remove("d-none"),bulkDeleteButton.classList.remove("d-none"),this.getItemCheckboxes().forEach((checkbox=>{checkbox.classList.remove("d-none"),checkbox.checked=!1})))})),disableBulkDeleteButton.addEventListener("click",(()=>{disableBulkDeleteButton.classList.add("d-none"),bulkDeleteButton.classList.add("d-none"),bulkDeleteButton.disabled=!0,enableBulkDeleteButton.classList.remove("d-none"),selectAllContainer.classList.add("d-none"),this.getItemCheckboxes().forEach((checkbox=>{checkbox.classList.add("d-none"),checkbox.checked=!1}))})),bulkDeleteButton.addEventListener("click",(async()=>{if(bulkDeleteButton.disabled)return;const itemIds=[];this.getItemCheckboxes().forEach((checkbox=>{checkbox.checked&&itemIds.push(checkbox.value)})),await this.confirmDeleteItems(itemIds)}))}async setupItem(element){const itemElement=this.#baseFactory.block().item().element(this,element);if("0"!==itemElement.getStatus()&&this.isBulkDeleteEnabled()){const checkbox=element.querySelector('input[data-action="bulk_select"][type="checkbox"]');checkbox?.classList?.remove("d-none")}this.#element.querySelector(".no-items").classList.add("d-none");const existingItemIndex=this.#items.findIndex((i=>i.getItemId()===itemElement.getItemId()));-1!==existingItemIndex?this.#items[existingItemIndex]=itemElement:this.#items.push(itemElement),this.updateBulkDeleteButtonState(),this.updateSelectAllState()}getItemCheckboxes(){return this.#element.querySelectorAll('.sharing_cart_item:not([data-status="0"]) input[data-action="bulk_select"][type="checkbox"]')}updateBulkDeleteButtonState(){this.#element.querySelector("#block_sharing_cart_bulk_delete_confirm").disabled=!Array.from(this.getItemCheckboxes()).some((checkbox=>checkbox.checked))}updateSelectAllState(){const selectAllCheckbox=this.#element.querySelector("#select_all_box"),selectAllLabel=this.#element.querySelector("#select_all_label"),itemCheckboxes=this.getItemCheckboxes(),allSelected=Array.from(itemCheckboxes).every((checkbox=>checkbox.checked)),someSelected=Array.from(itemCheckboxes).some((checkbox=>checkbox.checked));(allSelected?(0,_str.get_string)("deselect_all","block_sharing_cart"):(0,_str.get_string)("select_all","block_sharing_cart")).then((str=>{selectAllLabel.textContent=str})),selectAllCheckbox.checked=allSelected,selectAllCheckbox.indeterminate=!allSelected&&someSelected}isBulkDeleteEnabled(){return this.#bulkDeleteEnabled}async setClipboard(item){this.#clipboardItem=item,await this.#course.setClipboard(item)}clearClipboard(){this.#clipboardItem=null}setDraggedSectionId(id){this.#draggedSectionId=id}setDraggedCourseModuleId(id){this.#draggedCourseModuleId=id}async removeItemElement(item){item.getItemChildrenRecursively().forEach((childItem=>{const index=this.#items.findIndex((i=>i.getItemId()===Number.parseInt(childItem.dataset.itemid)));-1!==index&&(this.#items[index].getItemId()===this.#clipboardItem?.getItemId()&&this.#course.clearClipboard(),this.#items.splice(index,1),childItem.remove())}));const index=this.#items.findIndex((i=>i.getItemId()===item.getItemId()));this.#items[index].getItemId()===this.#clipboardItem?.getItemId()&&this.#course.clearClipboard(),this.#items.splice(index,1),item.remove(),0===this.#items.length&&this.#element.querySelector(".no-items").classList.remove("d-none")}deleteItem(item){_ajax.default.call([{methodname:"block_sharing_cart_delete_item_from_sharing_cart",args:{item_id:item.getItemId()},done:async deleted=>{deleted?(await this.removeItemElement(item),this.updateSelectAllState()):await _notification.default.alert("Failed to delete item")},fail:data=>{_notification.default.exception(data)}}])}deleteItems(itemIds){itemIds=itemIds.map((id=>Number.parseInt(id))),_ajax.default.call([{methodname:"block_sharing_cart_delete_items_from_sharing_cart",args:{item_ids:itemIds},done:async deletedItemIds=>{const items=this.#items.filter((i=>itemIds.includes(i.getItemId())));for(const item of items){deletedItemIds.includes(item.getItemId())?await this.removeItemElement(item):_notification.default.alert('Failed to delete item: "'+item.getItemName()+'"')}this.updateSelectAllState(),document.getElementById("block_sharing_cart_bulk_delete_confirm").disabled=!0},fail:data=>{_notification.default.exception(data)}}])}getElement(){return this.#element}async createBackupItemToSharingCartModal(itemName,onSave){const strings=await(0,_str.get_strings)([{key:"backup_item",component:"block_sharing_cart"},{key:"into_sharing_cart",component:"block_sharing_cart"},{key:"backup",component:"block_sharing_cart"},{key:"cancel",component:"core"}]),{html:html,js:js}=await this.#baseFactory.moodle().template().renderTemplate("block_sharing_cart/modal/backup_to_sharing_cart_modal_body",{show_user_data_backup:this.#canBackupUserdata,show_anonymize_user_data:this.#canBackupUserdata&&this.#canAnonymizeUserdata}),modal=await _modal_factory.default.create({type:_modal_factory.default.types.SAVE_CANCEL,title:strings[0]+': "'+itemName.slice(0,50).trim()+'" '+strings[1],body:html,buttons:{save:strings[2],cancel:strings[3]},removeOnClose:!0});return modal.getRoot().on(_modal_events.default.shown,(()=>this.#baseFactory.moodle().template().runTemplateJS(js))),modal.getRoot().on(_modal_events.default.save,(()=>{const modalUserdataCheckbox=document.getElementById("modal-userdata-checkbox"),modalAnonymizeCheckbox=document.getElementById("modal-anonymize-checkbox");onSave({users:modalUserdataCheckbox?.checked??!1,anonymize:modalAnonymizeCheckbox?.checked??!1})})),modal}async addSectionBackupToSharingCart(sectionId){const sectionName=this.#course.getSectionName(sectionId);if(0===this.#course.getSectionCourseModules(sectionId).length){const strings=await(0,_str.get_strings)([{key:"no_course_modules_in_section",component:"block_sharing_cart"},{key:"no_course_modules_in_section_description",component:"block_sharing_cart"}]);return void await _notification.default.alert(strings[0],strings[1])}const modal=await this.createBackupItemToSharingCartModal(sectionName,(settings=>{_ajax.default.call([{methodname:"block_sharing_cart_backup_section_into_sharing_cart",args:{section_id:sectionId,settings:settings},done:async data=>{await this.renderItem(data)},fail:data=>{_notification.default.exception(data)}}])}));await modal.show()}async addCourseModuleBackupToSharingCart(courseModuleId){const courseModuleName=this.#course.getCourseModuleName(courseModuleId),modal=await this.createBackupItemToSharingCartModal(courseModuleName,(settings=>{_ajax.default.call([{methodname:"block_sharing_cart_backup_course_module_into_sharing_cart",args:{course_module_id:courseModuleId,settings:settings},done:async data=>{await this.renderItem(data)},fail:data=>{_notification.default.exception(data)}}])}));await modal.show()}async renderItem(item){const existingItemIndex=this.#items.findIndex((i=>i.getItemId()===item.id)),existingItem=this.#items[existingItemIndex]??!1,getOldElement=()=>this.#element.querySelector('.sharing_cart_items .sharing_cart_item[data-itemid="'+item.id+'"]'),oldElement=getOldElement();if(existingItem&&oldElement){const element=await this.#baseFactory.moodle().template().createElementFromFragment("block_sharing_cart","item",1,{item_id:item.id});if(getOldElement()!==oldElement)return;this.#element.querySelector(".sharing_cart_items").replaceChild(element,oldElement),this.#items[existingItemIndex]=this.#baseFactory.block().item().element(this,element),await this.setupItem(element);for(const subItem of element.querySelectorAll(".sharing_cart_item"))await this.setupItem(subItem);return}const element=await this.#baseFactory.moodle().template().createElementFromTemplate("block_sharing_cart/block/item",{id:item.id,name:item.name,type:item.type,status:0,old_instance_id:item.old_instance_id,status_awaiting:!0,has_run_now:!0,task_id:item.task_id??null,status_finished:!1,status_failed:!1,is_module:"section"!==item.type,is_section:"section"===item.type,is_root:!0});this.#element.querySelector(".sharing_cart_items").prepend(element),await this.setupItem(element)}importItem(item,sectionId,modal){this.#course.clearClipboard();const courseModuleIds=[];if(modal.querySelectorAll('input[type="checkbox"][data-type="coursemodule"]:checked').forEach((checkbox=>{courseModuleIds.push(checkbox.dataset.id)})),item.isSection()&&0===courseModuleIds.length)return modal.querySelectorAll(".form-check-input").forEach((async item=>{item.setCustomValidity(await(0,_str.get_string)("atleast_one_course_module_must_be_included","block_sharing_cart")),item.reportValidity()})),!1;item.isModule()&&courseModuleIds.push(item.getItemOldInstanceId()),_ajax.default.call([{methodname:"block_sharing_cart_restore_item_from_sharing_cart_into_section",args:{item_id:item.getItemId(),section_id:sectionId,course_modules_to_include:courseModuleIds},done:async success=>{success&&await this.#queue.loadQueue(!0)},fail:data=>{_notification.default.exception(data)}}])}async confirmImportBackupFromSharingCart(item,sectionId,e){e.preventDefault(),e.stopPropagation();const strings=await(0,_str.get_strings)([{key:"copy_item",component:"block_sharing_cart"},{key:"into_section",component:"block_sharing_cart"},{key:"import",component:"core"},{key:"cancel",component:"core"}]),sectionName=this.#course.getSectionName(sectionId),pageContextId=document.getElementById("block_sharing_cart").getAttribute("data-contextid"),{html:html,js:js}=await this.#baseFactory.moodle().template().renderFragment("block_sharing_cart","item_restore_form",pageContextId,{item_id:item.getItemId()}),modal=await _modal_factory.default.create({type:_modal_factory.default.types.SAVE_CANCEL,title:strings[0]+': "'+item.getItemName().slice(0,50).trim()+'" '+strings[1]+': "'+sectionName.slice(0,50).trim()+'"',body:html,buttons:{save:strings[2],cancel:strings[3]},removeOnClose:!0});modal.getRoot().on(_modal_events.default.shown,(()=>this.#baseFactory.moodle().template().runTemplateJS(js))),modal.getRoot().on(_modal_events.default.save,this.importItem.bind(this,item,sectionId,modal.getRoot()[0])),await modal.show()}async confirmDeleteItems(itemIds){const strings=await(0,_str.get_strings)([{key:"delete_items",component:"block_sharing_cart"},{key:"confirm_delete_items",component:"block_sharing_cart"},{key:"delete",component:"core"},{key:"cancel",component:"core"}]),modal=await _modal_factory.default.create({type:_modal_factory.default.types.DELETE_CANCEL,title:strings[0],body:strings[1],buttons:{delete:strings[2],cancel:strings[3]},removeOnClose:!0});modal.getRoot().on(_modal_events.default.delete,this.deleteItems.bind(this,itemIds)),await modal.show()}},_exports.default}));

//# sourceMappingURL=element.min.js.map